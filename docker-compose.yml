version: '3.8'

services:
  # ----------------------------------------------------------------
  # 1. API Gateway (Kong)
  # ----------------------------------------------------------------
  kong:
    image: kong:3.7
    container_name: kong
    environment:
      KONG_DATABASE: "off" # نستخدم التكوين التصريحي
      KONG_DECLARATIVE_CONFIG: "/opt/kong/declarative/kong.yml"
      KONG_PROXY_LISTEN: "0.0.0.0:8000, 0.0.0.0:8443 ssl"
      KONG_ADMIN_LISTEN: "0.0.0.0:8001, 0.0.0.0:8444 ssl"
    ports:
      - "8000:8000" # Proxy HTTP
      - "8001:8001" # Admin API HTTP
    volumes:
      - ./api-gateway/kong.yml:/opt/kong/declarative/kong.yml
    networks:
      - app-network
    depends_on:
      - quiz-service
  konga:
    image: pantsel/konga:latest
    container_name: konga
    ports:
      - "1337:1337"
    environment:
      NODE_ENV: production
    networks:
      - app-network
    depends_on:
      - kong


  # ----------------------------------------------------------------
  # 2. Quiz Service
  # ----------------------------------------------------------------
  quiz-service:
    build:
      context: ./quiz_service
      dockerfile: Dockerfile
    container_name: quiz-service
    ports:
      - "8002:8000" # منفذ داخلي للخدمة (يمكن الوصول إليه عبر Kong)
    environment:
      DATABASE_URL: postgresql://user:password@quiz-db:5432/quiz_db
      KAFKA_BROKERS: kafka:9092
      # يجب استبدال هذه القيم ببيانات AWS الحقيقية عند النشر
      AWS_ACCESS_KEY_ID: "YOUR_AWS_ACCESS_KEY_ID"
      AWS_SECRET_ACCESS_KEY: "YOUR_AWS_SECRET_ACCESS_KEY"
      S3_BUCKET_NAME: "quiz-service-storage-dev"
      AWS_REGION: "us-east-1"
    networks:
      - app-network
    depends_on:
      - quiz-db
      - kafka
  tts-service:
    build:
      context: ./tts_service
      dockerfile: Dockerfile
    container_name: tts-service
    ports:
      - "8003:8000"
    environment:
      KAFKA_BROKERS: kafka:9092
    networks:
      - app-network
    depends_on:
      - kafka


  # ----------------------------------------------------------------
  # 3. PostgreSQL Database for Quiz Service
  # ----------------------------------------------------------------
  quiz-db:
    image: postgres:15-alpine
    container_name: quiz-db
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: quiz_db
    volumes:
      - quiz_data:/var/lib/postgresql/data
    networks:
      - app-network

  # ----------------------------------------------------------------
  # 4. Kafka and Zookeeper (محاكاة لبيئة AWS MSK)
  # ----------------------------------------------------------------
  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - app-network

  kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    networks:
      - app-network
    depends_on:
      - zookeeper

volumes:
  quiz_data:

networks:
  app-network:
    driver: bridge
